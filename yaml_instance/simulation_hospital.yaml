# Hospital Multi-Agent Simulation
# Uses multiple specialized models for different agent roles
#
# MODELS IN USE:
# - gemma2-9b-it-psy10k-mental_health-i1: Medical staff - specialized medical knowledge

version: 0.1.0

vars:
  api_key: ${API_KEY}
  base_url: ${BASE_URL}
  # Higher number of patients will need a more powerful model
  NUMBER_OF_PATIENTS: 1
  COMMON_PROMPT: |
    You are an intelligent agent participating in a high-fidelity hospital simulation.
    
    CORE DIRECTIVES:
    1. IMMERSION: Stay in character at all times. Never break the fourth wall.
    2. ADAPTABILITY: Your behavior, tone, and pacing must change dynamically based on the "Hospital Atmosphere" described in the input.
    
    Current Role:

graph:
  id: hospital_simulation_lmstudio_multimodel
  description: |
    Multi-model hospital simulation using specialized LLMs:
    - Medical staff uses biomedical model for accurate medical responses
    - Patients use general Qwen model for natural conversation
    - Dynamic Execution: Simulates multiple parallel patients.
    Optimized for 8B parameter models with reduced context and token limits.
  
  log_level: DEBUG
  
  # Memory stores - reduced size for local models
  memory:
    - name: nurse_memory
      type: simple
      config:
        embedding:
          provider: openai
          base_url: ${BASE_URL}
          api_key: ${API_KEY}
          model: text-embedding-bge-reranker-v2-m3
    
    - name: patient_shared_memory
      type: simple
      config:
        embedding:
          provider: openai
          base_url: ${BASE_URL}
          api_key: ${API_KEY}
          model: text-embedding-bge-reranker-v2-m3
  
  nodes:
    # Input Processor
    - id: InputProcessor
      type: passthrough
      name: Input Processor
      description: 'Initial entry point for user input'
      config: {}

    # Environment Coordinator (General Conversational Model)
    - id: environment
      name: Hospital Environment
      type: agent
      description: 'Generates atmospheric context for the simulation'
      config:
        role: |
          ${COMMON_PROMPT}
          You are the hospital environment coordinator.
          
          Provide a detailed atmospheric description that will directly influence all agents' behavior throughout the simulation.
          
          REQUIREMENTS:
          - Include Urgency Level (Low/Medium/High/Critical) - how busy and stressed the hospital is
          - Specify Staffing Status (Fully Staffed/Understaffed/Skeleton Crew)
          - Describe Time Context (time of day, day of week, season)
          - Note any Notable Conditions (weather impact, outbreak situation, equipment status, recent incidents)
          - Convey the Emotional Atmosphere (Calm/Tense/Chaotic/Somber) affecting everyone
          
          OUTPUT FORMAT:
          Provide 3-5 sentences painting a vivid picture that will make nurses rushed or relaxed, doctors thorough or quick, and patients more or less anxious. Be specific and concrete - these details will directly shape how every agent behaves.
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.7
          max_tokens: 800
      
    # Patient Generator (Creates parallel scenarios)
    - id: PatientGenerator
      name: Patient Coordinator
      type: agent
      description: 'Generates multiple patient personas based on environment'
      config:
        role: |
          ${COMMON_PROMPT}
          You are a simulation coordinator generating patient scenarios.
          
          Based on the hospital environment described, generate exactly ${NUMBER_OF_PATIENTS} distinct patient scenarios/personas that match the environmental context.
          
          REQUIREMENTS:
          - Patient scenarios MUST align with the hospital environment context
          - If specific outbreak mentioned: Generate related symptoms
          - Mix simple and complex cases appropriately for the environment
          - Patient name MUST be meaningful and unique
          - Output STRICT JSON ONLY - no conversational text
          
          OUTPUT FORMAT:
          Provide a list of exactly ${NUMBER_OF_PATIENTS} JSON objects with mandatory fields:
          
          [
            {
              "name": "Sarah",
              "symptoms": "Fever, cough",
              "personality": "Anxious",
              "context": "Middle-aged woman...",
              "urgency": "Medium"
            },
            {
              "name": "John",
              "symptoms": "...",
              "personality": "...",
              "context": "...",
              "urgency": "Low/Medium/High"
            }
          ]
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.7
          max_tokens: 1200

    # Router Node for Patient Regex Split
    - id: PatientRouter
      type: passthrough
      name: Patient Router
      description: 'Routes generated patients for splitting'
      config: {}

    # Generic Patient Agent (Runs in Parallel)
    - id: PatientAgent
      name: Patient
      type: agent
      description: 'Simulates individual patient behavior'
      config:
        role: |
          ${COMMON_PROMPT}
          You are a patient arriving at the hospital.
          
          Your persona is defined by the input text provided. Act out this persona and approach the nurse.
          
          REQUIREMENTS:
          - You MUST state your basic information clearly (name, context, and symptoms)
          - Stay in character based on your persona
          - Keep response brief (3-4 sentences)
          
          OUTPUT FORMAT:
          Introduce yourself naturally including mandatory information:
          - Your name ("My name is..." or "I'm...")
          - Brief context (age, occupation, or relevant background)
          - Your symptoms or reason for visit
          
          Example: "Hi, my name is Sarah. I'm 45 years old and I've been having severe headaches for the past three days."
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.8
          max_tokens: 1000
        memories:
          - name: patient_shared_memory
            top_k: 5
            retrieve_stage:
              - gen
        
    # End Node (Diagnosis)
    - id: Discharge
      type: agent
      name: Discharge Clerk
      description: 'Generates discharge summary'
      config:
        role: |
          ${COMMON_PROMPT}
          You are a discharge clerk at the hospital.
          
          Extract patient information from the doctor's diagnosis and create a concise discharge summary.
          
          REQUIREMENTS:
          - Extract the actual patient name from the "PATIENT:" line (do NOT use placeholders)
          - Find the diagnosis from the "DIAGNOSIS:" line
          - Include the condition and brief treatment plan if mentioned
          - Keep summary to 1-2 sentences
          
          OUTPUT FORMAT:
          Patient [ACTUAL NAME] discharged with diagnosis: [CONDITION]. [Brief treatment plan if mentioned].
          
          Example: Patient Michael Chen discharged with diagnosis: suspected appendicitis requiring immediate surgical evaluation.
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.3
          max_tokens: 150

    # Doctor Agent - Diagnosis
    - id: DoctorDiagnosis
      name: Dr. House (Diagnosis)
      type: agent
      description: 'Final diagnostic decision maker'
      config:
        role: |
          ${COMMON_PROMPT}
          You are Dr. Gregory House, a brilliant diagnostician known for methodical reasoning.
          
          Make a final clinical decision based on the complete patient history provided. You are tracking multiple patients in parallel, each with their own separate history.
          
          REQUIREMENTS:
          - Retrieve actual patient data from memory (do NOT use placeholder text)
          - Extract patient name from the "patient" field first
          - Review the "history" field thoroughly before making decisions
          - Look for patient names in the nurse intake conversation
          - Follow the mandatory diagnostic process below
          
          DIAGNOSTIC PROCESS:
          1. Extract Patient Name from the "patient" field
          2. Summarize Key Findings - list all symptoms, timeline, relevant history
          3. Differential Diagnosis - consider 2-3 possible conditions based on evidence
          4. Reasoning - explain which findings support or rule out each possibility
          5. Final Decision - choose one:
             - If confident: "DIAGNOSIS: [Specific condition] - [Brief treatment plan]"
             - If critical/unclear/life-threatening: "TRANSFER: ER immediately - [Specific concern]"
          
          OUTPUT FORMAT:
          PATIENT: <ACTUAL_PATIENT_NAME_FROM_NURSE_INTAKE>
          
          SUMMARY OF KEY FINDINGS
          [4-8 sentences of medical reasoning showing diagnostic thought process]
          
          FINAL DECISION: [Either "DIAGNOSIS:" or "TRANSFER:" with details]
                  
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.7
          max_tokens: 2000
        memories:
          - name: nurse_memory
            top_k: 10
            retrieve_stage:
              - gen

    # Doctor Agent - Intake
    - id: DoctorIntake
      name: Dr. House (Intake)
      type: agent
      description: 'Conducts patient intake interview'
      config:
        role: |
          ${COMMON_PROMPT}
          You are Dr. Gregory House conducting patient intake.
          
          The hospital atmosphere described affects your patience and approach. You are tracking multiple patients in parallel, each with their own separate history.
          
          REQUIREMENTS:
          - Retrieve actual patient data from memory
          - Look for patient names in the nurse intake conversation
          - Your questions must be medically related
          - You will only ask questions, do not provide any other output
          
          OUTPUT FORMAT:
          QUESTION: [Question]
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.7
          max_tokens: 1600
        memories:
          - name: nurse_memory
            top_k: 5
            retrieve_stage:
              - gen

    # Medical Scribe (DoctorNotes)
    - id: DoctorNotes
      name: Medical Scribe
      type: agent
      description: 'Maintains patient notes and handles loop aggregation'
      config:
        role: |
          ${COMMON_PROMPT}
          You are a medical scribe maintaining patient clinical notes.
          
          You MUST NEVER ask questions. During normal workflow, you track ONE patient interaction at a time. Only when receiving the explicit "LOOP ENDED." signal do you compile ALL patients.
          
          REQUIREMENTS:
          - Retrieve actual patient data from memory (do NOT use placeholder text)
          - Extract real patient names from nurse intake notes
          - Output STRICT JSON ONLY - no conversational text
          - CRITICAL: Do NOT output arrays until you receive "LOOP ENDED." signal
          
          TASK SCENARIOS:
          
          1. NORMAL WORKFLOW (default - most common):
             - You receive a single patient's answer/interaction
             - Focus on THIS ONE PATIENT ONLY
             - Identify which patient from memory context
             - Extract that patient's actual name from conversation history
             - Add this new information to that patient's notes
             - Output ONLY UPDATE format (never an array during this phase)
          
          2. LOOP SIGNAL (only when input explicitly contains "LOOP ENDED."):
             - This signals the question loop has ended for ALL patients
             - NOW retrieve ALL patient histories from memory
             - Extract all real patient names from nurse intake notes
             - Output ONLY a bare JSON array (no wrapper object)
             - Do NOT copy example names - use actual names from memory
          
          OUTPUT FORMAT EXAMPLES (replace placeholders with real data from memory):
          
          For NORMAL WORKFLOW - UPDATE OBJECT ONLY (ONE PATIENT):
          {
            "status": "UPDATE",
            "patient": "<ACTUAL_PATIENT_NAME_FROM_NURSE_INTAKE>",
            "content": "Q1: Nurse intake - <ACTUAL_SYMPTOMS_AND_CONTEXT_FROM_MEMORY>. Q2: <ACTUAL_DOCTOR_QUESTION> - <ACTUAL_PATIENT_ANSWER>. Q3: ... Q4: ..."
          }
          
          For "LOOP ENDED." signal - BARE JSON ARRAY ONLY (ALL PATIENTS):
          [
            {
              "patient": "<ACTUAL_PATIENT_NAME_FROM_NURSE_INTAKE>",
              "history": "Q1: Nurse intake - <ACTUAL_SYMPTOMS_AND_CONTEXT_FROM_MEMORY>. Q2: <ACTUAL_DOCTOR_QUESTION> - <ACTUAL_PATIENT_ANSWER>. Q3: ... Q4: ..."
            },
            {
              "patient": "<SECOND_PATIENT_NAME_FROM_NURSE_INTAKE>",
              "history": "Q1: ... Q2: ... Q3: ... Q4: ..."
            }
          ]
          
          CRITICAL NOTES:
          - Default behavior: OUTPUT UPDATE object for single patient
          - Only output array when you see "LOOP ENDED." in the input
          - Examples show FORMAT only - populate with real data from memory
          - No "LOOP" text in the history output
          - Include question sequence with actual content
          
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.1
          max_tokens: 2500
        memories:
          - name: nurse_memory
            top_k: 20
            retrieve_stage:
              - gen

    # Router for DoctorNotes
    - id: DoctorNotesRouter
      type: passthrough
      name: Doctor Notes Router
      description: 'Routes output based on update vs timeout'
      config: {}
    
    # Patient History Splitter - Extracts patient array from TIMEOUT message
    - id: PatientHistorySplitter
      type: passthrough
      name: Patient History Splitter
      description: Extracts and splits patient histories for parallel diagnosis
      config: {}

    # Nurse Agent - Jackie
    - id: Nurse
      name: Nurse Jackie
      type: agent
      description: 'Triage nurse handling initial intake'
      config:
        role: |
          ${COMMON_PROMPT}
          You are Nurse Jackie, an empathetic triage nurse.
          
          You are the first point of contact. Your job is to intake the patient before sending them to the doctor. 
          You MUST get basic information (name, context and symptoms) from the patient and provide a preliminary assessment based on their symptoms.
          
          REQUIREMENTS:
          - Adapt behavior based on hospital environment conditions
          - DO NOT ASK QUESTIONS. You must state or confirm the facts provided by the patient.
          - Extract: Name, Basic Context (age/occupation), and Symptoms.
          - Speak professionally but let the environment affect your demeanor.
          
          BEHAVIOR GUIDELINES BY ENVIRONMENT:
          - High Urgency/Overwhelming: Be brisk, efficient, skip pleasantries.
          - Calm/Low Volume: Be warmer, reassuring.
          - Crisis/Chaotic: Direct, focused, visible stress.
          - Well Staffed/Quiet: Thorough, friendly.
          
          OUTPUT FORMAT:
          Respond naturally as Nurse Jackie, adapting your tone and pacing to match the hospital conditions.
          Patient basic information is mandatory before referral to the doctor.
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.7
          max_tokens: 1500
        memories:
          - name: nurse_memory
            top_k: 5
            retrieve_stage:
              - gen

    # Transfer Node (Failure/Referral)
    - id: ER Transfer
      type: agent
      name: Transfer Coordinator
      description: 'Generates transfer summary'
      config:
        role: |
          ${COMMON_PROMPT}
          You are a transfer coordinator at the hospital.
          
          Extract patient information from the doctor's transfer order and create a brief transfer summary.
          
          REQUIREMENTS:
          - Extract the actual patient name from the "PATIENT:" line (do NOT use placeholders)
          - Find the destination and reason from the "TRANSFER:" line
          - Include destination (ER, ICU, specialist department, or external facility)
          - Include primary reason for transfer
          - Keep summary to 1-2 sentences maximum
          
          OUTPUT FORMAT:
          Patient [ACTUAL NAME] transferred to [DESTINATION] for [REASON].
          
          Example: Patient Michael Chen transferred to Emergency Room for suspected appendicitis requiring immediate surgical evaluation.
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.3
          max_tokens: 300

    # Patient Interaction Node (For Doctor Loop)
    - id: PatientInteraction
      name: Patient (Exam Room)
      type: agent
      description: 'Simulates patient responses during exam'
      config:
        role: |
          ${COMMON_PROMPT}
          You are a patient in the exam room with Dr. House
          
          Maintain your persona and answer the doctor's questions. You may be dramatic or difficult if your persona fits.
          
          REQUIREMENTS:
          - Speak in FIRST PERSON ("I feel...", "My pain...")
          - Do NOT speak about the patient in third person
          - Do NOT behave as an AI
          - Stay in character based on your persona
          - Keep answers brief (2-3 sentences)
          
          OUTPUT FORMAT:
          Respond naturally as the patient from the patient's perspective.
        
        provider: openai
        name: gemma2-9b-it-psy10k-mental_health-i1
        api_key: ${api_key}
        base_url: ${base_url}
        params:
          temperature: 0.8
          max_tokens: 500

    # Loop Counter Guard (Limit Questions)
    - id: LoopGuard
      type: loop_counter
      name: Question Limiter
      description: 'Limits the number of doctor questions'
      config:
        max_iterations: 8
        reset_on_emit: true
        message: "LOOP ENDED."

  # ================== Interaction Flow ==================
  edges:
    # Scene initialization
    - from: InputProcessor
      to: environment
      trigger: true
      condition: 'true'
      carry_data: true
      processor:
        type: template
        template: |
          Scenario: {{task_prompt}}
          
          Create a DETAILED, VIVID hospital atmosphere description (3-5 sentences) that will DIRECTLY shape all agent behaviors.
          
          REQUIRED: Include specific details about:
          - Urgency Level (Low/Medium/High/Critical)
          - Staffing Status (Fully Staffed/Understaffed/Skeleton Crew)
          - Time Context and any special conditions
          - Emotional Atmosphere affecting everyone
          
          Be CONCRETE - these details will control how rushed, stressed, or calm everyone acts.
    
    # Environment -> Generator
    - from: environment
      to: PatientGenerator
      trigger: true
      condition: 'true'
      carry_data: true
      processor:
        type: template
        template: |
          ===== HOSPITAL ENVIRONMENT CONTEXT =====
          {{input}}
          ========================================
          
          Based on this SPECIFIC hospital atmosphere, generate 2 distinct, VIVID patient personas.
          
          REQUIREMENTS:
          - Patient behaviors should reflect the emotional atmosphere (anxious if chaotic, relaxed if calm)
          - Consider how the described conditions would realistically affect who shows up
          
          Make them diverse in age, personality, and severity of symptoms while staying TRUE to the environment.
    
    # Generator -> Router (Regex Split)
    - from: PatientGenerator
      to: PatientRouter
      trigger: true
      condition: 'true'
      carry_data: true
      dynamic:
        type: map
        split:
          type: regex
          config:
            # Matches individual JSON objects inside the list (lazy match between braces)
            pattern: "(?s)\\{.*?\\}"
        config:
          max_parallel: 10
      processor:
        type: template
        template: "{{input}}"
    
    # Router -> Patient (Message Split)
    - from: PatientRouter
      to: PatientAgent
      trigger: true
      condition: 'true'
      carry_data: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10 # Parallel Waiting Room
      processor:
        type: template
        template: |
          You are the patient described in this JSON data:
          {{input}}
          
          You are currently standing at the hospital reception.
          Approach Nurse Jackie and explain what's wrong. Be dramatic or quiet depending on your persona.
          Don't use any "Action:" prefixes. Just speak naturally.
    
    # Patient -> Nurse
    - from: PatientAgent
      to: Nurse
      trigger: true
      condition: 'true'
      carry_data: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
      processor:
        type: template
        template: |
          ===== CURRENT HOSPITAL CONDITIONS =====
          {{environment.output}}
          ========================================
          
          Patient says: "{{input}}"
          
          Respond as Nurse Jackie. 
          
          REQUIREMENTS: Your demeanor, pacing, and thoroughness must DIRECTLY reflect the hospital conditions above.
          - Match your stress level to the urgency
          - Show visible effects of understaffing, chaos, or calmness
          - You MUST NOT ask any questions to the patient
          - Patient basic information is mandatory before referral to the doctor
          
          Then refer them to Dr. House for diagnosis.
    
    # Nurse -> DoctorIntake (Referral)
    - from: Nurse
      to: DoctorIntake
      trigger: true
      condition: 'true'
      carry_data: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
      processor:
        type: template
        template: |
          ===== CURRENT HOSPITAL CONDITIONS =====
          {{environment.output}}
          ========================================
          
          Nurse Referral Note: {{input}}
          
          Dr. House, the hospital conditions above should DIRECTLY affect your approach.
          Adapt your interview style accordingly.
    
    # DoctorIntake -> Patient (Loop)
    - from: DoctorIntake
      to: PatientInteraction
      trigger: true
      condition: 'true'
      carry_data: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
      processor:
        type: template
        template: |
          The Doctor says: "{{input}}"
          
          Answer him, but feel free to be intimidated or annoyed by his manner.

    # Patient -> DoctorNotes (Update History)
    - from: PatientInteraction
      to: DoctorNotes
      trigger: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
      processor:
        type: template
        template: |
          Patient Answer: "{{input}}"

    # DoctorNotes -> Router
    - from: DoctorNotes
      to: DoctorNotesRouter
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
      processor:
        type: template
        template: "{{input}}"

    # Router -> DoctorIntake (Loop Return - UPDATE only, NOT array)
    - from: DoctorNotesRouter
      to: DoctorIntake
      trigger: true
      condition:
        type: keyword
        config:
          any: 
            - "UPDATE"
          none: []
          case_sensitive: false
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
      processor:
        type: regex_extract
        config:
          pattern: '["""]content["""]\s*:\s*["""](?P<content>(?:[^"""\\]|\\.)*)["""]'
          group: "content"
          template: |
            Clinical Notes: {{content}}
            
            Analyze this history. 
            - If you need more info, ask QUESTION.
          dotall: true

    # Router -> PatientHistorySplitter
    - from: DoctorNotesRouter
      to: PatientHistorySplitter
      trigger: true
      carry_data: true
      condition:
        type: keyword
        config:
          any: []
          none:
            - "UPDATE"
          case_sensitive: false
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
    
    # PatientHistorySplitter -> DoctorDiagnosis (Regex split like PatientGenerator)
    - from: PatientHistorySplitter
      to: DoctorDiagnosis
      trigger: true
      condition: 'true'
      carry_data: true
      dynamic:
        type: map
        split:
          type: regex
          config:
            # Matches individual JSON objects inside the list (lazy match between braces)
            # Same pattern as PatientGenerator -> PatientRouter
            pattern: "(?s)\\{.*?\\}"
        config:
          max_parallel: 10
      processor:
        type: template
        template: |
          {{input}}
          
          TIMEOUT: Maximum questions reached. 
          Review the patient history above and make your final diagnosis now.

    # DoctorDiagnosis -> Discharge
    - from: DoctorDiagnosis
      to: Discharge
      trigger: true
      carry_data: true
      condition:
        type: keyword
        config:
          any:
            - "DIAGNOSIS:"
          none:
            - "TRANSFER"
            - "Transfer"
      regex: []
      case_sensitive: false
      dynamic:
        type: map
        split:
          type: json_path
          config:
            json_path: ""
        config:
          max_parallel: 10
      processor:
        type: template
        template: |
          Final Medical Report: {{input}}

    # DoctorDiagnosis -> ER Transfer
    - from: DoctorDiagnosis
      to: ER Transfer
      trigger: true
      carry_data: true
      condition:
        type: keyword
        config:
          any:
            - "TRANSFER"
            - "Transfer"
          none: []
      regex: []
      case_sensitive: false
      dynamic:
        type: map
        split:
          type: json_path
          config:
            json_path: ""
        config:
          max_parallel: 10
      processor:
        type: template
        template: |
          Transfer Order: {{input}}

    # ================== Loop Guard Edges ==================
    
    # PatientInteraction -> LoopGuard (Count Iterations)
    - from: PatientInteraction
      to: LoopGuard
      trigger: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
    
    # LoopGuard -> DoctorIntake (Keep LoopGuard INSIDE the cycle)
    - from: LoopGuard
      to: DoctorIntake
      trigger: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10

    # LoopGuard -> DoctorNotes (When limit reached, signal TIMEOUT)
    - from: LoopGuard
      to: DoctorNotes
      trigger: true
      dynamic:
        type: map
        split:
          type: message
        config:
          max_parallel: 10
      processor:
        type: template
        template: "LOOP ENDED. Finalize notes."

  # ================== SCENARIO PRESETS ==================
  # Copy/paste one of these into the initial_instruction field below:
  #
  # 1. PANDEMIC START (COVID-19):
  #    'March 2020, COVID-19 outbreak beginning. Hospital scrambling to set up isolation protocols. Staff anxious, limited PPE supplies, unclear treatment guidelines. Emergency department separating respiratory cases. High tension, everyone on edge.'
  #
  # 2. NUCLEAR DISASTER (Chernobyl):
  #    'April 26, 1986, Pripyat Hospital. 2:00 AM. Firefighters arriving with violent radiation burns and confusion. Geiger counters off the charts. Staff unprotected and unaware of the true danger. Military lockdown. Atmosphere of invisible dread.'
  #
  # 3. NATURAL DISASTER (Hurricane Katrina):
  #    'August 2005, New Orleans Hospital. Hurricane Katrina aftermath. Power failing, floodwaters rising. No AC, stifling heat. Critical supplies running low. Staff exhausted and making desperate evacuation decisions.'
  #
  # 4. MASS CASUALTY (Stadium Collapse):
  #    'Friday Night, Metro General. Structural collapse at a packed stadium. Mass casualty incident. Sudden influx of crush injuries and trauma. Triage tents in parking lot. Blood bank critical. Chaos and high-decibel urgency.'
  #
  # 5. INFRASTRUCTURE FAILURE (Cyber Attack + Blizzard):
  #    'Winter 2025. Total hospital network failure due to ransomware. No electronic records, no labs, no imaging. Backup generators only. Snowstorm preventing transfers. Staff flying blind with paper charts. High anxiety and communication breakdown.'

  initial_instruction: Describe the scenario for the hospital simulation (e.g., 'March 2020, COVID-19 outbreak beginning. Hospital scrambling to set up isolation protocols. Staff anxious, limited PPE supplies, unclear treatment guidelines. Emergency department separating respiratory cases. High tension, everyone on edge.'). The system will simulate multiple patients arriving in parallel.
  start:
    - InputProcessor
  
  end:
    - Discharge
    - ER Transfer
