# ===================================================================
# TEMPLATE DEMONSTRATION WORKFLOW
# ===================================================================
# This workflow demonstrates TWO ways to use Jinja2 templates:
#
# 1. EDGE TEMPLATE PROCESSORS (lines 150-227)
#    - Transform data BETWEEN nodes on edges
#    - Output appears in the TARGET node's input
#    - Use case: Data transformation, format conversion
#    - Examples: PatientDataGenerator → AdmissionReport
#
# 2. TEMPLATE NODES (lines 144-228)
#    - Format data WITHIN node execution
#    - Output appears in node's own logs
#    - Use case: Formatted reports, summaries, dashboards
#    - Examples: DischargeSummaryFormatter, MetricsDashboard
#
# Key Difference:
# - Edge processors transform data in transit
# - Template nodes are formatting destinations
# ===================================================================

graph:
  id: template_demo
  description: Template edge processor and template node demonstration with practical examples
  description: Template edge processor and template node demonstration with practical examples
  log_level: INFO
  is_majority_voting: false
  nodes:
    - id: PatientDataGenerator
      type: agent
      config:
        name: ${MODEL_NAME}
        provider: openai
        role: |
          Generate a JSON object with patient data. Output ONLY valid JSON:
          {
            "patient_name": "John Smith",
            "age": 68,
            "condition": "Influenza",
            "severity": "high",
            "admission_date": "2024-01-15"
          }
        base_url: ${BASE_URL}
        api_key: ${API_KEY}
        params: {}
        tooling: null
        thinking: null
        memories: []
        retry: null
      description: Generates patient admission data
      context_window: 0
      log_output: true
      name: Patient Data Generator
    - id: AdmissionReport
      type: agent
      config:
        name: ${MODEL_NAME}
        provider: openai
        role: You received a patient admission report. Acknowledge it.
        base_url: ${BASE_URL}
        api_key: ${API_KEY}
        params: {}
        tooling: null
        thinking: null
        memories: []
        retry: null
      description: ''
      context_window: 0
      log_output: true
      name: Admission Report Handler
    - id: DailySummary
      type: agent
      config:
        name: ${MODEL_NAME}
        provider: openai
        role: You received multiple reports. Create a brief daily summary.
        base_url: ${BASE_URL}
        api_key: ${API_KEY}
        params: {}
        tooling: null
        thinking: null
        memories: []
        retry: null
      description: ''
      context_window: 0
      log_output: true
      name: Daily Summary Generator
    - id: TriageReport
      type: agent
      config:
        name: ${MODEL_NAME}
        provider: openai
        role: You received a triage status report. Acknowledge it.
        base_url: ${BASE_URL}
        api_key: ${API_KEY}
        params: {}
        tooling: null
        thinking: null
        memories: []
        retry: null
      description: ''
      context_window: 0
      log_output: true
      name: Triage Report Handler
    - id: StatusReport
      type: template
      type: template
      config:
        template: |
          STATUS REPORT RECEIVED
          
          {{ input }}
          
          Report Status: ✓ LOGGED
      description: Formats status acknowledgment
        template: |
          STATUS REPORT RECEIVED
          
          {{ input }}
          
          Report Status: ✓ LOGGED
      description: Formats status acknowledgment
      context_window: 0
      log_output: true
      name: Status Report Handler
    - id: TriageDataGenerator
      type: agent
      config:
        name: ${MODEL_NAME}
        provider: openai
        role: |
          Generate a JSON array of 3 patients in triage:
          [
            {"name": "Alice Johnson", "priority": "high", "wait_time": 5},
            {"name": "Bob Williams", "priority": "medium", "wait_time": 20},
            {"name": "Carol Davis", "priority": "low", "wait_time": 45}
          ]
          Output ONLY valid JSON.
        base_url: ${BASE_URL}
        api_key: ${API_KEY}
        params: {}
        tooling: null
        thinking: null
        memories: []
        retry: null
      description: Generates triage queue data
      context_window: 0
      log_output: true
      name: Triage Data Generator
    - id: StatusGenerator
      type: agent
      config:
        name: ${MODEL_NAME}
        provider: openai
        role: 'Output exactly: "Hospital operations normal"'
        base_url: ${BASE_URL}
        api_key: ${API_KEY}
        params: {}
        tooling: null
        thinking: null
        memories: []
        retry: null
      description: ''
      context_window: 0
      log_output: true
      name: Status Generator
    
    - id: DischargeDataGenerator
      type: agent
      config:
        name: ${MODEL_NAME}
        provider: openai
        role: |
          Generate a JSON object with patient discharge data. Output ONLY valid JSON:
          {
            "patient_name": "Emily Chen",
            "age": 75,
            "admission_date": "2024-01-20",
            "discharge_date": "2024-01-25",
            "diagnosis": "Pneumonia",
            "treatment": "Antibiotics and respiratory therapy",
            "medications": ["Azithromycin 250mg", "Albuterol inhaler"],
            "follow_up": "Visit pulmonologist in 1 week"
          }
        base_url: ${BASE_URL}
        api_key: ${API_KEY}
        params: {}
        tooling: null
        thinking: null
        memories: []
        retry: null
      description: Generates patient discharge data
      context_window: 0
      log_output: true
      name: Discharge Data Generator
    
    - id: DischargeSummaryFormatter
      type: template
      config:
        template: |
          {% set patient = input | fromjson %}
          
          PATIENT DISCHARGE SUMMARY
          
          Patient Information:
          - Name: {{ patient.patient_name }}
          - Age: {{ patient.age }} years
          
          Admission & Discharge:
          - Admitted: {{ patient.admission_date }}
          - Discharged: {{ patient.discharge_date }}
          
          Medical Details:
          - Diagnosis: {{ patient.diagnosis }}
          - Treatment: {{ patient.treatment }}
          
          Medications Prescribed:
          {% for med in patient.medications %}
          {{ loop.index }}. {{ med }}
          {% endfor %}
          
          Follow-up Care:
          {{ patient.follow_up }}
          
          {% if patient.age > 65 %}
          Special Note: Elderly patient - ensure caregiver support.
          {% endif %}
      description: Formats patient discharge summary using template node
      context_window: 0
      log_output: true
      name: Discharge Summary Formatter
    
    - id: HospitalMetrics
      type: literal
      config:
        content: "Today: 45 admissions, 38 discharges, 12 in ER"
        role: user
      description: Simple hospital metrics
      context_window: 0
      log_output: true
      name: Hospital Metrics
    
    - id: MetricsDashboard
      type: template
      config:
        template: |
          HOSPITAL METRICS DASHBOARD         
          
          {{ input | upper }}
          
          Status: ALL SYSTEMS OPERATIONAL ✓
          Last Updated: {{ environment.run_id | default('N/A') }}
      description: Formats metrics into dashboard using template node
      context_window: 0
      log_output: true
      name: Metrics Dashboard
  edges:
    # ===================================================================
    # EDGE TEMPLATE PROCESSORS - Transform data on edges between nodes
    # ===================================================================
    
    - from: PatientDataGenerator
      to: AdmissionReport
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor:
        type: template
        config:
          template: |
            PATIENT ADMISSION REPORT
            
            
            {% set patient = input | fromjson %}

            Patient Information:
            - Name: {{ patient.patient_name }}
            - Age: {{ patient.age }} years
            - Condition: {{ patient.condition }}
            - Admission Date: {{ patient.admission_date }}

            Severity Assessment:
            {% if patient.severity == "high" %}
            URGENT: Immediate attention required
            Priority: CRITICAL
            {% elif patient.severity == "medium" %}
            NOTICE: Review within 24 hours
            Priority: MODERATE
            {% else %}
            ROUTINE: Standard processing
            Priority: LOW
            {% endif %}

            Case Summary:
            {{ patient.patient_name }} ({{ patient.age }}y) admitted with {{ patient.condition }}.
            {% if patient.age > 60 %}
            Note: Elderly patient - additional monitoring recommended.
            {% endif %}
    - from: TriageDataGenerator
      to: TriageReport
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor:
        type: template
        config:
          template: |
            TRIAGE QUEUE STATUS
            
            
            {% set patients = input | fromjson %}

            Current Queue ({{ patients | length }} patients):

            {% for patient in patients %}
            {{ loop.index }}. {{ patient.name }}
               Priority: {{ patient.priority | upper }}
               Wait Time: {{ patient.wait_time }} min
               {% if patient.priority == 'high' %}
               → ALERT: Fast-track this patient
               {% elif patient.wait_time > 30 %}
               → WARNING: Extended wait time
               {% endif %}
            {% endfor %}
    - from: StatusGenerator
      to: StatusReport
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor:
        type: template
        config:
          template: |
            System Status: {{ input }}
            Emergency Level: {{ emergency_level | default('None') }}
            Timestamp: {{ timestamp | default('Not specified') }}
    
    # ===================================================================
    # TEMPLATE NODE EDGES - Connect to template nodes (no processor needed)
    # ===================================================================
    
    - from: DischargeDataGenerator
      to: DischargeSummaryFormatter
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    - from: HospitalMetrics
      to: MetricsDashboard
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    # Flow to final aggregator
    
    # ===================================================================
    # TEMPLATE NODE EDGES - Connect to template nodes (no processor needed)
    # ===================================================================
    
    - from: DischargeDataGenerator
      to: DischargeSummaryFormatter
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    - from: HospitalMetrics
      to: MetricsDashboard
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    # Flow to final aggregator
    - from: AdmissionReport
      to: DailySummary
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    - from: TriageReport
      to: DailySummary
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    - from: StatusReport
      to: DailySummary
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    - from: DischargeSummaryFormatter
      to: DailySummary
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    - from: MetricsDashboard
      to: DailySummary
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    - from: DischargeSummaryFormatter
      to: DailySummary
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
    
    - from: MetricsDashboard
      to: DailySummary
      trigger: true
      condition: 'true'
      carry_data: true
      keep_message: false
      clear_context: false
      clear_kept_context: false
      processor: null
  memory: []
  initial_instruction: ''
  start:
    - PatientDataGenerator
    - TriageDataGenerator
    - StatusGenerator
    - DischargeDataGenerator
    - HospitalMetrics
    - DischargeDataGenerator
    - HospitalMetrics
  end:
    - DailySummary
version: 0.0.0
vars:
  MODEL_NAME: qwen/qwen3-8b
